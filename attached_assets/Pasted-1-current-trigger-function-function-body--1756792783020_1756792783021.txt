1. current trigger function
| function_body                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | function_name        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------- |
| 
BEGIN
    -- Handle INSERT (new keyword added)
    IF TG_OP = 'INSERT' THEN
        INSERT INTO indb_keyword_usage (user_id, keywords_used, keywords_limit, period_start, period_end)
        VALUES (
            NEW.user_id,
            1,
            (
                SELECT COALESCE(
                    CASE 
                        WHEN p.quota_limits->>'keywords_limit' = '-1' THEN -1
                        WHEN p.quota_limits->>'keywords_limit' IS NOT NULL THEN (p.quota_limits->>'keywords_limit')::integer
                        ELSE 50
                    END, 50
                )
                FROM indb_auth_user_profiles up
                LEFT JOIN indb_payment_packages p ON up.package_id = p.id
                WHERE up.user_id = NEW.user_id
            ),
            date_trunc('month', NOW())::timestamp with time zone,
            (date_trunc('month', NOW()) + interval '1 month - 1 second')::timestamp with time zone
        )
        ON CONFLICT (user_id, period_start) DO UPDATE SET
            keywords_used = indb_keyword_usage.keywords_used + 1,
            updated_at = NOW();
        
        RETURN NEW;
    END IF;
    
    -- Handle UPDATE (keyword activated/deactivated)
    IF TG_OP = 'UPDATE' THEN
        -- If keyword was activated
        IF OLD.is_active = false AND NEW.is_active = true THEN
            INSERT INTO indb_keyword_usage (user_id, keywords_used, keywords_limit, period_start, period_end)
            VALUES (
                NEW.user_id,
                1,
                (
                    SELECT COALESCE(
                        CASE 
                            WHEN p.quota_limits->>'keywords_limit' = '-1' THEN -1
                            WHEN p.quota_limits->>'keywords_limit' IS NOT NULL THEN (p.quota_limits->>'keywords_limit')::integer
                            ELSE 50
                        END, 50
                    )
                    FROM indb_auth_user_profiles up
                    LEFT JOIN indb_payment_packages p ON up.package_id = p.id
                    WHERE up.user_id = NEW.user_id
                ),
                date_trunc('month', NOW())::timestamp with time zone,
                (date_trunc('month', NOW()) + interval '1 month - 1 second')::timestamp with time zone
            )
            ON CONFLICT (user_id, period_start) DO UPDATE SET
                keywords_used = indb_keyword_usage.keywords_used + 1,
                updated_at = NOW();
        END IF;
        
        -- If keyword was deactivated
        IF OLD.is_active = true AND NEW.is_active = false THEN
            UPDATE indb_keyword_usage 
            SET keywords_used = GREATEST(0, keywords_used - 1),
                updated_at = NOW()
            WHERE user_id = NEW.user_id 
            AND period_start = date_trunc('month', NOW())::timestamp with time zone;
        END IF;
        
        RETURN NEW;
    END IF;
    
    -- Handle DELETE (keyword removed)
    IF TG_OP = 'DELETE' THEN
        UPDATE indb_keyword_usage 
        SET keywords_used = GREATEST(0, keywords_used - 1),
            updated_at = NOW()
        WHERE user_id = OLD.user_id 
        AND period_start = date_trunc('month', NOW())::timestamp with time zone;
        
        RETURN OLD;
    END IF;
    
    RETURN NULL;
END;
 | update_keyword_usage |
 
 
2. Current Trigger Definition
| trigger_name          | table_name            | function_body                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | trigger_definition                                                                                                                                         |
| --------------------- | --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| keyword_usage_trigger | indb_keyword_keywords | 
BEGIN
    -- Handle INSERT (new keyword added)
    IF TG_OP = 'INSERT' THEN
        INSERT INTO indb_keyword_usage (user_id, keywords_used, keywords_limit, period_start, period_end)
        VALUES (
            NEW.user_id,
            1,
            (
                SELECT COALESCE(
                    CASE 
                        WHEN p.quota_limits->>'keywords_limit' = '-1' THEN -1
                        WHEN p.quota_limits->>'keywords_limit' IS NOT NULL THEN (p.quota_limits->>'keywords_limit')::integer
                        ELSE 50
                    END, 50
                )
                FROM indb_auth_user_profiles up
                LEFT JOIN indb_payment_packages p ON up.package_id = p.id
                WHERE up.user_id = NEW.user_id
            ),
            date_trunc('month', NOW())::timestamp with time zone,
            (date_trunc('month', NOW()) + interval '1 month - 1 second')::timestamp with time zone
        )
        ON CONFLICT (user_id, period_start) DO UPDATE SET
            keywords_used = indb_keyword_usage.keywords_used + 1,
            updated_at = NOW();
        
        RETURN NEW;
    END IF;
    
    -- Handle UPDATE (keyword activated/deactivated)
    IF TG_OP = 'UPDATE' THEN
        -- If keyword was activated
        IF OLD.is_active = false AND NEW.is_active = true THEN
            INSERT INTO indb_keyword_usage (user_id, keywords_used, keywords_limit, period_start, period_end)
            VALUES (
                NEW.user_id,
                1,
                (
                    SELECT COALESCE(
                        CASE 
                            WHEN p.quota_limits->>'keywords_limit' = '-1' THEN -1
                            WHEN p.quota_limits->>'keywords_limit' IS NOT NULL THEN (p.quota_limits->>'keywords_limit')::integer
                            ELSE 50
                        END, 50
                    )
                    FROM indb_auth_user_profiles up
                    LEFT JOIN indb_payment_packages p ON up.package_id = p.id
                    WHERE up.user_id = NEW.user_id
                ),
                date_trunc('month', NOW())::timestamp with time zone,
                (date_trunc('month', NOW()) + interval '1 month - 1 second')::timestamp with time zone
            )
            ON CONFLICT (user_id, period_start) DO UPDATE SET
                keywords_used = indb_keyword_usage.keywords_used + 1,
                updated_at = NOW();
        END IF;
        
        -- If keyword was deactivated
        IF OLD.is_active = true AND NEW.is_active = false THEN
            UPDATE indb_keyword_usage 
            SET keywords_used = GREATEST(0, keywords_used - 1),
                updated_at = NOW()
            WHERE user_id = NEW.user_id 
            AND period_start = date_trunc('month', NOW())::timestamp with time zone;
        END IF;
        
        RETURN NEW;
    END IF;
    
    -- Handle DELETE (keyword removed)
    IF TG_OP = 'DELETE' THEN
        UPDATE indb_keyword_usage 
        SET keywords_used = GREATEST(0, keywords_used - 1),
            updated_at = NOW()
        WHERE user_id = OLD.user_id 
        AND period_start = date_trunc('month', NOW())::timestamp with time zone;
        
        RETURN OLD;
    END IF;
    
    RETURN NULL;
END;
 | CREATE TRIGGER keyword_usage_trigger AFTER INSERT OR DELETE OR UPDATE ON public.indb_keyword_keywords FOR EACH ROW EXECUTE FUNCTION update_keyword_usage() |
 
 3. Duplicate Record Pattern
 | user_id                              | record_count | records                                                                                                                                                                                                                                                                                                                                                                                                    |
| ------------------------------------ | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 915f50e5-0902-466a-b1af-bdf19d789722 | 2            | [{"id":"7e5d8ce7-157f-4b79-a8b9-838b2ed97874","keywords_used":1,"period_start":"2025-09-01T00:00:00+00:00","period_end":"2025-09-30T23:59:59+00:00","created_at":"2025-09-01T19:21:29.385455+00:00"},{"id":"ce9cf213-74b5-4d9d-bd57-f64835b69f34","keywords_used":147,"period_start":"2025-08-01T00:00:00+00:00","period_end":"2025-08-31T23:59:59+00:00","created_at":"2025-08-18T17:31:40.28792+00:00"}] |