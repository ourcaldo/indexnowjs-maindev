| function_body                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | function_name        |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------- |
| 
BEGIN
    -- Handle INSERT (new keyword added)
    IF TG_OP = 'INSERT' THEN
        INSERT INTO indb_keyword_usage (user_id, keywords_used, keywords_limit, period_start, period_end)
        VALUES (
            NEW.user_id,
            1,
            (
                SELECT COALESCE(
                    CASE 
                        WHEN p.quota_limits->>'keywords_limit' = '-1' THEN -1
                        WHEN p.quota_limits->>'keywords_limit' IS NOT NULL THEN (p.quota_limits->>'keywords_limit')::integer
                        ELSE 50
                    END, 50
                )
                FROM indb_auth_user_profiles up
                LEFT JOIN indb_payment_packages p ON up.package_id = p.id
                WHERE up.user_id = NEW.user_id
            ),
            date_trunc('month', NOW())::timestamp with time zone,
            (date_trunc('month', NOW()) + interval '1 month - 1 second')::timestamp with time zone
        )
        ON CONFLICT (user_id, period_start) DO UPDATE SET
            keywords_used = indb_keyword_usage.keywords_used + 1,
            updated_at = NOW();
        
        RETURN NEW;
    END IF;
    
    -- Handle UPDATE (keyword activated/deactivated)
    IF TG_OP = 'UPDATE' THEN
        -- If keyword was activated
        IF OLD.is_active = false AND NEW.is_active = true THEN
            INSERT INTO indb_keyword_usage (user_id, keywords_used, keywords_limit, period_start, period_end)
            VALUES (
                NEW.user_id,
                1,
                (
                    SELECT COALESCE(
                        CASE 
                            WHEN p.quota_limits->>'keywords_limit' = '-1' THEN -1
                            WHEN p.quota_limits->>'keywords_limit' IS NOT NULL THEN (p.quota_limits->>'keywords_limit')::integer
                            ELSE 50
                        END, 50
                    )
                    FROM indb_auth_user_profiles up
                    LEFT JOIN indb_payment_packages p ON up.package_id = p.id
                    WHERE up.user_id = NEW.user_id
                ),
                date_trunc('month', NOW())::timestamp with time zone,
                (date_trunc('month', NOW()) + interval '1 month - 1 second')::timestamp with time zone
            )
            ON CONFLICT (user_id, period_start) DO UPDATE SET
                keywords_used = indb_keyword_usage.keywords_used + 1,
                updated_at = NOW();
        END IF;
        
        -- If keyword was deactivated
        IF OLD.is_active = true AND NEW.is_active = false THEN
            UPDATE indb_keyword_usage 
            SET keywords_used = GREATEST(0, keywords_used - 1),
                updated_at = NOW()
            WHERE user_id = NEW.user_id 
            AND period_start = date_trunc('month', NOW())::timestamp with time zone;
        END IF;
        
        RETURN NEW;
    END IF;
    
    -- Handle DELETE (keyword removed)
    IF TG_OP = 'DELETE' THEN
        UPDATE indb_keyword_usage 
        SET keywords_used = GREATEST(0, keywords_used - 1),
            updated_at = NOW()
        WHERE user_id = OLD.user_id 
        AND period_start = date_trunc('month', NOW())::timestamp with time zone;
        
        RETURN OLD;
    END IF;
    
    RETURN NULL;
END;
 | update_keyword_usage |